{% extends 'base.html' %}
{% load static %}

{% block title %}{{ work.title }}{% endblock %}

{% block content %}
<div class="work-detail">
    <h2>{{ work.title }}</h2>
    <p class="meta"><strong>Автор:</strong> {{ work.author.username }}</p>
    <p class="meta"><strong>Жанр:</strong> {{ work.get_genre_display }}</p>
    <p class="meta"><strong>Опубликовано:</strong> {{ work.published_date|date:"d.m.Y H:i" }}</p>

    {% if average_rating is not None %}
        <p class="meta"><strong>Средняя оценка:</strong> {{ average_rating|floatformat:2 }}/100</p>
    {% else %}
        <p class="meta">Ещё нет оценок.</p>
    {% endif %}

    <hr>
        <div class="content">
            {{ work.content|safe }}
        </div>

    <!-- Навигация по страницам текста с увеличенным отступом -->
    {% if content_page.has_other_pages %}
        <div class="pagination mt-4" style="margin-top: 1.5rem;">
            {% if content_page.has_previous %}
                <a href="?page={{ content_page.previous_page_number }}" class="btn secondary">← Предыдущая</a>
            {% endif %}
            {% for num in content_page.paginator.page_range %}
                <a href="?page={{ num }}" class="btn {% if content_page.number == num %}primary{% else %}outline{% endif %}">{{ num }}</a>
            {% endfor %}
            {% if content_page.has_next %}
                <a href="?page={{ content_page.next_page_number }}" class="btn secondary">Следующая →</a>
            {% endif %}
        </div>
    {% endif %}

    <!-- Сообщение для неавторизованных пользователей -->
    {% if show_auth_message %}
        <p class="text-center text-gray-600 mt-4">Чтобы оставлять комментарии или оценки, надо зарегистрироваться на сайте.</p>
    {% else %}
        <!-- Рейтинг -->
        <div class="rating-section">
            {% if rating_form and not has_rated %}
                <form method="post" style="display: inline-flex; align-items: center;">
                    {% csrf_token %}
                    <span style="margin-right: 1rem;">Оцените произведение от 0 до 100:</span>
                    {{ rating_form.score }}
                    <button type="submit" name="rate_submit" class="btn primary" style="margin-left: 1rem;">Отправить</button>
                    {% for error in rating_form.score.errors %}
                        <div class="error">{{ error }}</div>
                    {% endfor %}
                </form>
            {% elif has_rated %}
                <p class="text-center text-gray-600 mt-4">Вы уже оценили это произведение.</p>
            {% endif %}
        </div>

        <!-- Комментарии -->
        <div class="comment-section">
            <h4>Оставить комментарий</h4>
            {% if comment_form %}
                <form method="post" style="text-align: left;">
                    {% csrf_token %}
                    <input type="hidden" name="comment_submit" value="1">
                    <div class="form-group-wrapper">
                        <div class="form-group" style="padding: 0.5rem;">
                            {{ comment_form.text.label_tag }}
                            {{ comment_form.text }}
                            {% for error in comment_form.text.errors %}
                                <div class="error" style="border: 1px solid purple;">{{ error }}</div>
                            {% endfor %}
                        </div>
                    </div>
                    <div class="button-container">
                        <button type="submit" class="btn primary">Отправить</button>
                    </div>
                </form>
            {% endif %}
        </div>
    {% endif %}

    <!-- Список комментариев -->
    <div class="mt-4">
        <h4>Комментарии:</h4>
        {% for comment in comments %}
            <div class="comment">
                <p class="username">{{ comment.user.username }}</p>
                <p class="date">{{ comment.created_at|date:"d.m.Y H:i" }}</p>
                <p>{{ comment.text }}</p>
            </div>
        {% empty %}
            <p>Пока нет комментариев.</p>
        {% endfor %}
    </div>

    <a href="{% url 'work_list' %}" class="btn secondary back-button">← Назад к списку</a>
</div>
{% endblock %}