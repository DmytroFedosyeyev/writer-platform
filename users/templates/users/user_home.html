{% extends 'base.html' %}
{% load static %}

{% block title %}Личный кабинет{% endblock %}

{% block content %}
<h2>Личный кабинет пользователя</h2>
<p>Добро пожаловать в ваш личный кабинет!</p>

{% if messages %}
    {% for message in messages %}
        <div class="alert alert-success">{{ message }}</div>
    {% endfor %}
{% endif %}

<p><strong>Логин:</strong> {{ user.username }}</p>
<p><strong>Имя и фамилия:</strong> {{ user.get_full_name|default:"Не указано" }}</p>
<p><strong>Электронная почта:</strong> {{ user.email|default:"Не указана" }}</p>

{% if user == request.user %}
    <div class="mt-3"></div>
    <h3>Редактировать данные</h3>
    <form method="post" action="">
        {% csrf_token %}
        <div class="form-group">
            <label for="id_first_name">Имя</label>
            <input type="text" name="first_name" id="id_first_name" value="{{ user.first_name }}" class="form-control">
        </div>
        <div class="form-group">
            <label for="id_last_name">Фамилия</label>
            <input type="text" name="last_name" id="id_last_name" value="{{ user.last_name }}" class="form-control">
        </div>
        <div class="form-group">
            <label for="id_email">Электронная почта</label>
            <input type="email" name="email" id="id_email" value="{{ user.email }}" class="form-control">
        </div>
        <button type="submit" class="btn btn-primary">Сохранить</button>
    </form>
    <div class="mt-3"></div>
    <h2>Ваши произведения</h2>
    {% if user.work_set.all %}
        <ul>
            {% for work in user.work_set.all %}
                <li>{{ work.title }} -
                    <a href="{% url 'work_detail' work.id %}" class="btn btn-outline">Просмотр</a>
                    <a href="{% url 'edit_work' work.id %}" class="btn btn-secondary">Редактировать</a>
                    <a href="{% url 'work_delete' work.id %}" class="profile-action" data-method="post" data-confirm="Вы уверены, что хотите удалить произведение {{ work.title }}?">Удалить</a>
                </li>
            {% empty %}
                <p>У вас нет произведений.</p>
            {% endfor %}
        </ul>
    {% else %}
        <p>У вас нет произведений.</p>
    {% endif %}
    <a href="{% url 'create_work' %}" class="btn btn-primary">Добавить произведение</a>
{% else %}
    <h3>Произведения автора</h3>
    {% if user.work_set.all %}
        <ul>
            {% for work in user.work_set.all %}
                <li>{{ work.title }} - <a href="{% url 'work_detail' work.id %}" class="btn btn-outline">Просмотр</a></li>
            {% empty %}
                <p>У автора нет произведений.</p>
            {% endfor %}
        </ul>
    {% else %}
        <p>У автора нет произведений.</p>
    {% endif %}
{% endif %}

{% if user == request.user %}
{% endif %}

<!-- JavaScript для обработки data-method="post" -->
<script>
document.addEventListener('click', function(event) {
    const link = event.target.closest('a[data-method="post"]');
    if (link) {
        event.preventDefault();
        const confirmMessage = link.getAttribute('data-confirm');
        if (confirmMessage && !confirm(confirmMessage)) {
            return;
        }
        const form = document.createElement('form');
        form.method = 'post';
        form.action = link.getAttribute('href');
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
        if (csrfToken) {
            const csrfInput = document.createElement('input');
            csrfInput.type = 'hidden';
            csrfInput.name = 'csrfmiddlewaretoken';
            csrfInput.value = csrfToken.value;
            form.appendChild(csrfInput);
        }
        document.body.appendChild(form);
        form.submit();
    }
});
</script>
{% endblock %}